<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">netkeiba のデータをスクレイピングして LOD 化する（6） | Kiai de Nantoka</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ningensei848.github.io/2023/02/07"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" name="twitter:title" content="Kiai de Nantoka"><meta data-rh="true" http-equiv="content-language" content="ja"><meta data-rh="true" property="og:title" content="netkeiba のデータをスクレイピングして LOD 化する（6） | Kiai de Nantoka"><meta data-rh="true" name="description" content="ML4Keiba に関する昨年の記事でも書いたように、ローカルだけでなくクラウド側にデータを保存し、それらをクラウド上の DB におさめて分析あるいはサービス提供できるようにしたいと考えている。"><meta data-rh="true" property="og:description" content="ML4Keiba に関する昨年の記事でも書いたように、ローカルだけでなくクラウド側にデータを保存し、それらをクラウド上の DB におさめて分析あるいはサービス提供できるようにしたいと考えている。"><meta data-rh="true" name="keywords" content="python,競馬,GCS,DWH"><meta data-rh="true" property="og:image" content="https://custom-og-image-generator.vercel.app/api/**netkeiba.com**%20%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6LOD%E5%8C%96%E3%81%99%E3%82%8B%EF%BC%886%EF%BC%89.png?theme=light&amp;copyright=Kiai+de+Nantoka&amp;logo=https%3A%2F%2Fimg.icons8.com%2Fglyph-neue%2F64%2F000000%2Fhorse.png&amp;avater=https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F20794309&amp;author=Kiai&amp;aka=%40Ningensei848&amp;site=%E6%B0%97%E5%90%88%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B&amp;tags=python&amp;tags=%E7%AB%B6%E9%A6%AC&amp;tags=GCS&amp;tags=DWH"><meta data-rh="true" name="twitter:image" content="https://custom-og-image-generator.vercel.app/api/**netkeiba.com**%20%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6LOD%E5%8C%96%E3%81%99%E3%82%8B%EF%BC%886%EF%BC%89.png?theme=light&amp;copyright=Kiai+de+Nantoka&amp;logo=https%3A%2F%2Fimg.icons8.com%2Fglyph-neue%2F64%2F000000%2Fhorse.png&amp;avater=https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F20794309&amp;author=Kiai&amp;aka=%40Ningensei848&amp;site=%E6%B0%97%E5%90%88%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B&amp;tags=python&amp;tags=%E7%AB%B6%E9%A6%AC&amp;tags=GCS&amp;tags=DWH"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-02-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://twitter.com/Ningensei848"><meta data-rh="true" property="article:tag" content="python,競馬,GCS,DWH"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ningensei848.github.io/2023/02/07"><link data-rh="true" rel="alternate" href="https://ningensei848.github.io/2023/02/07" hreflang="en"><link data-rh="true" rel="alternate" href="https://ningensei848.github.io/2023/02/07" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="気合でなんとか RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="気合でなんとか Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="気合でなんとか JSON Feed">



<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon.png">
<link rel="icon" sizes="32x32" href="/img/favicon-32x32.png">
<link rel="icon" sizes="16x16" href="/img/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="rgb(25, 150, 4)">
<meta rel="apple-mobile-web-app-title" content="気合でなんとか">
<meta rel="application-name" content="気合でなんとか">
<meta name="theme-color" content="rgb(25, 150, 4)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="msapplication-TileImage" content="/img/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#199604">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script>window.dataLayer=window.dataLayer||[]</script>
<script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-PCHTT2T",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
<link rel="preconnect" href="//fonts.gstatic.com" crossorigin="anonymous">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7857289120965920" crossorigin="anonymous"></script>
<script>window.twttr=function(t,e,r){var n,i=t.getElementsByTagName(e)[0],w=window.twttr||{};return t.getElementById(r)||((n=t.createElement(e)).id=r,n.src="https://platform.twitter.com/widgets.js",i.parentNode.insertBefore(n,i),w._e=[],w.ready=function(t){w._e.push(t)}),w}(document,"script","twitter-wjs")</script><link rel="stylesheet" href="/assets/css/styles.43d1b70d.css">
<link rel="preload" href="/assets/js/runtime~main.e370ff11.js" as="script">
<link rel="preload" href="/assets/js/main.903cefa2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>

<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PCHTT2T" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Kiai de Nantoka" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo_dark.svg" alt="Kiai de Nantoka" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Kiai de Nantoka</b></a></div><div class="navbar__items navbar__items--right"><a href="https://zenn.dev/ningensei848" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-zenn-link" aria-label="Zenn.dev Articles"></a><a href="https://twitter.com/Ningensei848" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-twitter-link" aria-label="Author on Twitter"></a><a href="https://github.com/ningensei848/ningensei848.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All our posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/03/03">netkeiba のデータをスクレイピングして LOD 化する（7）</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/2023/02/07">netkeiba のデータをスクレイピングして LOD 化する（6）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2023/02/01">2023 年を考える</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/11/14">ML4Keiba を具体的に考えていく</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/11/07">Docusaurus v2.2 へ更新した</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/06/17">Tweet を不特定多数の人々&quot;を利用して&quot;集めたい</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/06/09">ML4Keiba の展望</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/06/08">GitHub Codespaces やっべぇんですの！というご報告</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/05/15">Twitter API v2 (Elevated) はいいけどよくないという話</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/05/11">PC 環境がなくなって1ヶ月半が経過したけど…？</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/04/06">【オープンレター】署名者を検索するツールをつくった【#againstc】</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/04/01">貸与PCを返却して手元にはiPadしか残されていねぇ</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/30">netkeiba のデータをスクレイピングして LOD 化する（５）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/28">netkeiba のデータをスクレイピングして LOD 化する（４）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/23">netkeiba のデータをスクレイピングして LOD 化する（３）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/13">LOD Challenge 2021 授賞式に参加した</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/12">netkeiba のデータをスクレイピングして LOD 化する（２）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/08">netkeiba のデータをスクレイピングして LOD 化する（１）</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/2022/03/03">個人ブログを Docusaurus で再始動する</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemprop="image" content="https://custom-og-image-generator.vercel.app/api/**netkeiba.com**%20%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6LOD%E5%8C%96%E3%81%99%E3%82%8B%EF%BC%886%EF%BC%89.png?theme=light&amp;copyright=Kiai+de+Nantoka&amp;logo=https%3A%2F%2Fimg.icons8.com%2Fglyph-neue%2F64%2F000000%2Fhorse.png&amp;avater=https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F20794309&amp;author=Kiai&amp;aka=%40Ningensei848&amp;site=%E6%B0%97%E5%90%88%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B&amp;tags=python&amp;tags=%E7%AB%B6%E9%A6%AC&amp;tags=GCS&amp;tags=DWH"><header><h1 class="title_f1Hy" itemprop="headline">netkeiba のデータをスクレイピングして LOD 化する（6）</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-02-07T00:00:00.000Z" itemprop="datePublished">February 7, 2023</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://twitter.com/Ningensei848" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars.githubusercontent.com/u/20794309" alt="Kiai"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://twitter.com/Ningensei848" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Kiai</span></a></div><small class="avatar__subtitle" itemprop="description">@Ningensei848</small></div></div></div></div></header><meta itemprop="image" content="https://custom-og-image-generator.vercel.app/api/**netkeiba.com**%20%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6LOD%E5%8C%96%E3%81%99%E3%82%8B%EF%BC%886%EF%BC%89.png?theme=light&amp;copyright=Kiai+de+Nantoka&amp;logo=https%3A%2F%2Fimg.icons8.com%2Fglyph-neue%2F64%2F000000%2Fhorse.png&amp;avater=https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F20794309&amp;author=Kiai&amp;aka=%40Ningensei848&amp;site=%E6%B0%97%E5%90%88%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B&amp;tags=python&amp;tags=%E7%AB%B6%E9%A6%AC&amp;tags=GCS&amp;tags=DWH"><div id="post-content" class="markdown" itemprop="articleBody"><p><a href="/2022/11/14">ML4Keiba に関する昨年の記事</a>でも書いたように、ローカルだけでなくクラウド側にデータを保存し、それらをクラウド上の DB におさめて分析あるいはサービス提供できるようにしたいと考えている。</p><p>そんな折、以下の書籍を読む機会があり、そこでおおよその方向性がつかめたのでそれをまとめる。</p><p><a href="https://www.amazon.co.jp/%E5%AE%9F%E8%B7%B5%E7%9A%84%E3%83%87%E3%83%BC%E3%82%BF%E5%9F%BA%E7%9B%A4%E3%81%B8%E3%81%AE%E5%87%A6%E6%96%B9%E7%AE%8B%E3%80%9C-%E3%83%93%E3%82%B8%E3%83%8D%E3%82%B9%E4%BE%A1%E5%80%A4%E5%89%B5%E5%87%BA%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%83%BB%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%BB%E3%83%92%E3%83%88%E3%81%AE%E3%83%8E%E3%82%A6%E3%83%8F%E3%82%A6-%E3%82%86%E3%81%9A%E3%81%9F%E3%81%9D/dp/4297124459?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=1HANW989QOGUU&amp;keywords=%E5%AE%9F%E8%B7%B5%E7%9A%84%E3%83%87%E3%83%BC%E3%82%BF%E5%9F%BA%E7%9B%A4%E3%81%B8%E3%81%AE%E5%87%A6%E6%96%B9%E7%AE%8B&amp;qid=1675237604&amp;sprefix=%2Caps%2C180&amp;sr=8-1&amp;linkCode=li2&amp;tag=ningensei840a-22&amp;linkId=5eb6e6032a2cf49395b3a610e7dbd4e6&amp;language=ja_JP&amp;ref_=as_li_ss_il" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&amp;ASIN=4297124459&amp;Format=_SL250_&amp;ID=AsinImage&amp;MarketPlace=JP&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=ningensei840a-22&amp;language=ja_JP" alt="実践的データ基盤への処方箋〜 ビジネス価値創出のためのデータ・システム・ヒトのノウハウ 単行本（ソフトカバー） – 2021/12/11" class="img_ev3q"></a></p><p><a href="https://amzn.to/3DMKKQS" target="_blank" rel="noopener noreferrer">https://amzn.to/3DMKKQS</a></p><p>一言で言えば、　<strong>Cloud Functions x GCS x BigQuery で DWH をつくる構想</strong> といったところだろうか。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="データレイクとデータウェアハウスdwh">データレイクとデータウェアハウス（DWH）<a href="#データレイクとデータウェアハウスdwh" class="hash-link" aria-label="Direct link to データレイクとデータウェアハウス（DWH）" title="Direct link to データレイクとデータウェアハウス（DWH）">​</a></h2><p>まず、データレイクとは &quot;Data Lake&quot; であり、データソースという水源を一箇所に貯めておく湖（lake）のようなものであるらしい。
整っている必要は必ずしもなく、乱雑なデータをボンボコ入れていく場所を用意して<strong>必要になるかもしれないデータをすべて集積する</strong>ことに価値をおいている。
ロギングデータだったり複数部署から集めたデータだったり、たくさんあるし分析には必要だろうが、そのままでは使えないデータを一時的に（といいつつ半永久的に）保存しておくことになる。</p><p>データウェアハウス（DWH: Data Ware House）とは、データレイクに集めた<strong>データを分析できる状態に整理して堆積したもの</strong>であるようだ。
&quot;Warehouse&quot; で「倉庫」の意味であり、後に使うことを想定して収める際に整頓するという現実世界でのイメージと沿うだろうか。
また、「堆積」という語を使ったがこれには垂直方向のデータ圧縮すなわち「列指向圧縮」を意味している。
テキストや数値データをバイナリに変換し、Aggregation しやすいようにクエリ発行も専用のチューニングが施されているらしい。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="google-cloud-storage-と-bigquery">Google: Cloud Storage と BigQuery<a href="#google-cloud-storage-と-bigquery" class="hash-link" aria-label="Direct link to Google: Cloud Storage と BigQuery" title="Direct link to Google: Cloud Storage と BigQuery">​</a></h2><p>御存知の通り、GCS こと Google Cloud Storage は Google が誇る堅牢なクラウドストレージであり、前述したデータレイクとして利用する。
ここに貯めたデータから必要なものを抽出し大規模分析に活用するのが、データウェアハウスとしての BigQuery である。</p><p>AWS こと Amazon Web Services の S3:Simple Storage Service をストレージとして採用する場合もあるだろう。
（曰く、GCS は癖があるとか、AWS のほうがサポートが手厚い<!-- -->[<!-- -->?<!-- -->]<!-- -->からメインは AWS に置きたいらしい）
その場合でも、BigQuery からデータを読み取って利用することができる。
もっとも、AWS にも同様の機能を持つ<a href="https://aws.amazon.com/jp/redshift/" target="_blank" rel="noopener noreferrer">Amazon Redshift</a> があるらしいのだが……機能としてどちらのほうが優れているのだろうか？
知名度的には BigQuery に軍配が上がりそうだ。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="データの読み込み">データの読み込み<a href="#データの読み込み" class="hash-link" aria-label="Direct link to データの読み込み" title="Direct link to データの読み込み">​</a></h3><p>BigQuery は手元のファイルを直接読み込ませることにも対応しているが、今後サービス提供まで見据えてオペレーショナル DB も持つことを考えると、一旦はすべてを GCS に集積しておく方がいいだろう。
それを踏まえると、どうやって BigQuery から GCS のデータを読み取ればよいのだろうか。</p><p><a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-csv" target="_blank" rel="noopener noreferrer">Cloud Storage からの CSV データの読み込み | BigQuery | Google Cloud</a> を見ると、<code>Node.js</code> および <code>Python</code> で BigQuery のクライアントライブラリが提供されており、適切に初期設定を施した後、GCS の URI を指定すればあとはよしなにやってくれるようだ。
しかし、これだと単一ファイルしかロードできず、フォルダ内の膨大なファイル群を処理するには面倒……と思っていたところ、<code>*</code>（アスタリスク）を用いることで指定フォルダのサブフォルダまで再帰的に探ってまとめてロードしてくれるらしい。</p><p>cf. <a href="https://cloud.google.com/bigquery/docs/batch-loading-data#load-wildcards" target="_blank" rel="noopener noreferrer">Cloud Storage の URI でのワイルドカードの使用</a></p><p>だが、定期的に GCS へ更新データを入れた際に毎回フォルダ全体をアップロードしていては非効率だし重複データで溢れてしまう。
最初だけこの方法を用いて、更新データについては一つ一つ処理する必要がありそう……と思ったのも束の間、Cloud Functions には<a href="https://cloud.google.com/functions/docs/calling/storage" target="_blank" rel="noopener noreferrer">GCS のイベントトリガー</a>が実装されており、この内 <code>google.cloud.storage.object.v1.finalized</code> （ファイナライズ / 作成：オブジェクトの作成または上書き）　の際に実行されるようにすれば良いことがわかった。</p><p>贅沢を言えば、このイベントで受け取ったファイルが「新規作成」なのか「既存ファイルの更新」なのかは判定したいところだ。
既存のものを BigQuery にロードしてしまうと、重複データが入り込んでしまい後顧の憂いとなりうる（杞憂かもしれないが）。</p><p>&quot;Cloud Storage トリガの Cloud Function (第 2 世代) では、トリガの情報 (Cloud Storage にアップロードされたオブジェクトのパスやファイル名、サイズ等) が <a href="https://cloud.google.com/eventarc/docs/cloudevents" target="_blank" rel="noopener noreferrer"><em>CloudEvent</em> 形式</a> で渡され&quot;<sup id="fnref-1-9d14e2"><a href="#fn-1-9d14e2" class="footnote-ref">1</a></sup> てくるところまでは判明した。
しかし、このイベントで渡されるデータの中には「そのオブジェクトが更新されたものであるか」という確たる証明手段が含まれていない。
<a href="https://cloud.google.com/storage/docs/json_api/v1/objects#resource-representations" target="_blank" rel="noopener noreferrer">オブジェクトのプロパティに関する仕様説明</a>を読むと、おそらく <code>timeCreated</code> と <code>updated</code> <sup id="fnref-2-9d14e2"><a href="#fn-2-9d14e2" class="footnote-ref">2</a></sup> の一致を見ればよいはずだが、ごく短時間の間に GCS 側で metadata が更新されないとも限らない（更新されると <code>updated</code> の時刻がズレて更新ファイル判定されることになってしまう）。</p><p>「GCS にファイルをアップロードしてからファイナライズイベントが発生するまでの短時間では GCS がファイルオブジェクトのメタデータを更新することはない」という前提の元、 <em>CloudEvent</em> で返されるオブジェクトのプロパティ <strong><code>timeCreated</code> と <code>updated</code> とを単純に文字列として比較し、一致していれば新規ファイル、そうでなければ更新ファイル</strong>という判定方法を採用する。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="読み込みに関する注意点">読み込みに関する注意点<a href="#読み込みに関する注意点" class="hash-link" aria-label="Direct link to 読み込みに関する注意点" title="Direct link to 読み込みに関する注意点">​</a></h3><p>GCS &lt;---&gt; Cloud Functions &lt;---&gt; BigQuery という接続・自動化が実現しそうな目処がたった。</p><p>が、その前にさらに CSV / JSON データの内容について制限があるようだ。</p><p>cf. <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-csv#details_of_loading_csv_data" target="_blank" rel="noopener noreferrer">CSV データの読み込みの詳細 | BigQuery | Google Cloud</a></p><p>cf. <a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-json#details_of_loading_json_data" target="_blank" rel="noopener noreferrer">JSON データの読み込みの詳細 | BigQuery | Google Cloud</a></p><p>関係ありそうなものを抜粋すると以下の通り：</p><blockquote><p>CSV データまたは JSON データを読み込む場合、DATE 列の値に区切りとしてダッシュ（-）を使用し、YYYY-MM-DD（年-月-日）の形式にする必要があります。</p><p>JSON または CSV データを読み込む場合、TIMESTAMP 列のタイムスタンプ値の日付部分の区切りにはダッシュ（-）を使用し、日付は YYYY-MM-DD（年-月-日）の形式にする必要があります。タイムスタンプの時間部分 hh:mm:ss（時-分-秒）には、区切りとしてコロン（:）を使用します。</p></blockquote><p>これらの制限を念頭に、ETL のうち &quot;T&quot; の部分を再度実装を見直す必要がありそうだ。</p><hr><p>さらに、<a href="https://cloud.google.com/bigquery/docs/partitioned-tables" target="_blank" rel="noopener noreferrer"><strong>パーティショニング</strong></a>という概念にもぶつかった。
未だによくわかっていないが、取り敢えず大きすぎるテーブル一つで頑張るよりは複数に分けて（<em>partition</em>）やることで、</p><ol><li>データの管理や照会が簡単になる</li><li>クエリのパフォーマンスを高める</li><li>クエリによって読み取られるバイト数を減らしてコストを抑える</li></ol><p>といったメリットが得られるらしい。</p><p>BigQuery の場合は時間ごとに区切ることが一般的だが、その粒度によっては「一日ごと」だったり「年ごと」だったりする。
本案件のような場合、前者だと小さすぎるし後者だと大きすぎるので、「月ごと」の分割を採用するのが良いと考えている。</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> 参考：「列ベースの時間パーティショニング」の採用判断基準</summary><div><div class="collapsibleContent_i85q"><p>cf. <a href="https://cloud.google.com/bigquery/docs/partitioned-tables#when_to_use_partitioning" target="_blank" rel="noopener noreferrer">https://cloud.google.com/bigquery/docs/partitioned-tables#when_to_use_partitioning</a></p><blockquote><p>次のシナリオでは、テーブルのパーティショニングを検討してください。</p><ul><li>テーブルの一部のみをスキャンすることで、クエリのパフォーマンスを向上させる必要がある。</li><li>テーブル オペレーションが割り当てを超えており、テーブル オペレーションの範囲を特定のパーティション列の値に設定できる。</li><li><strong>クエリを実行する前にクエリ費用を把握する必要がある</strong>。</li></ul><p>BigQuery では、パーティション分割テーブルにクエリを実行する前のクエリ費用の見積もりが提供されます。
パーティション分割テーブルをプルーニングすることでクエリ費用を見積もり、続いてクエリ ドライランを発行してクエリ費用を見積もります。</p><hr><p>次のような場合は、テーブルをパーティショニングするのではなく、クラスタリングを検討してください。</p><ul><li>パーティショニングで許容されるよりも、細かい粒度が必要。</li><li>通常、クエリによって複数列に対するフィルタまたは集計が使用されている。</li><li>1 つの列または列グループの値のカーディナリティが大きい。</li><li>クエリを実行する前に厳密な費用見積もりが必要ない場合。</li></ul><p>このような場合、テーブル クラスタリングでは、ユーザー定義の並べ替えプロパティに基づいて特定の列のデータをクラスタリングすることで、クエリを高速化できます。</p></blockquote></div></div></details><h2 class="anchor anchorWithStickyNavbar_LWe7" id="さらなる自動化を目指して">さらなる自動化を目指して<a href="#さらなる自動化を目指して" class="hash-link" aria-label="Direct link to さらなる自動化を目指して" title="Direct link to さらなる自動化を目指して">​</a></h2><p>GCS にデータを集積すれば、それを検知して BigQuery に堆積してくれるところまでは実現できそうな見通しが立てられた。
次は、GCS へのデータ集積を自動化、もとい定期実行できるようにしたい。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="github-actions">GitHub Actions<a href="#github-actions" class="hash-link" aria-label="Direct link to GitHub Actions" title="Direct link to GitHub Actions">​</a></h3><p>まず考えたのは、これまで通り GitHub Actions で定期実行する方法だ。
時間的な上限があるとはいえ、それを超えない限りはいつまでも無料なのが最大の強みである。</p><p>さて、<a href="https://cloud.google.com/storage/docs/uploading-objects" target="_blank" rel="noopener noreferrer">ファイル システムからオブジェクトをアップロードする | Cloud Storage | Google Cloud</a>を見る限り、<code>bucket.blob.upload_from_filename(source_file_name)</code> あるいは <code>bucket.blob.upload_from_string(data, content_type)</code> を使用して、一つずつ地道にアップロードするしかないようだ。
（フォルダごとまとめてアップロード！とかはできない）</p><p>どうしてもまとめてアップロードしたい場合には、<code>gsutil</code> で <code>--recursive</code> オプションを使えばフォルダごとアップロードできる。</p><p><code>gsutil</code> がどのようにして料金が発生しているのか知る由もないが、JSON API でリクエスト（これはクラス A オペレーションなのでもっとも高めの料金となる）すると請求額がデカくなりそうでこわいという思いがある。
（まぁ 1000 回やってようやく $0.005 ~ $0.01 とかなので、たかが知れているといえばそうなのだが、ある程度は工夫して回数を減らしたいところである）</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gce">GCE<a href="#gce" class="hash-link" aria-label="Direct link to GCE" title="Direct link to GCE">​</a></h3><p>やっすい仮想マシンを借りてそこで Cron を仕込めば、時間上限もなく上述の <code>gsutil</code> によるアップロードがかんたんに実現できる。
マシンパワーこそ心配だが、リージョンを揃えればデータ転送の利用料金を０に抑えられるかもしれない</p><p>……と思ったけどやはりマシンパワーがかなり心もとない気がする。
予期しない変なところで地雷を踏みそうな、そういう嫌な予感しかしないのであんまり積極的に採用したくはない、最終手段として残しておくべきか……？</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloud-scheduler-x-pubsub-trigger-x-cloud-functions">Cloud Scheduler x Pub/Sub trigger x Cloud Functions<a href="#cloud-scheduler-x-pubsub-trigger-x-cloud-functions" class="hash-link" aria-label="Direct link to Cloud Scheduler x Pub/Sub trigger x Cloud Functions" title="Direct link to Cloud Scheduler x Pub/Sub trigger x Cloud Functions">​</a></h3><p>横断的にサービスを利用する分、最も金が掛かりそうに感じるのがこのアプローチだ。
GCP において、Cron のように定期実行するアプローチは今の所これくらいしか提供されていない。
（あるいは提供されているとしても、この方法よりは割高であるようだ）</p><p><a href="https://cloud.google.com/functions/docs/writing#directory-structure-python" target="_blank" rel="noopener noreferrer">Cloud Functions の関数を作成する | Google Cloud Functions に関するドキュメント</a>というページには関数の作成方法が Python でやる場合も、Node.js でやる場合も詳しく説明されている。</p><p>また、<a href="https://cloud.google.com/functions/docs/bestpractices/tips" target="_blank" rel="noopener noreferrer">ヒントとコツ</a>なんていう記事も存在している。
これに従って実装するとパフォーマンスは上がり、料金は抑えられるだろう。</p><p>ローカル環境で関数が作成できたら、次はデプロイだ。
<a href="https://cloud.google.com/functions/docs/deploy" target="_blank" rel="noopener noreferrer">Cloud Functions の関数をデプロイする | Google Cloud Functions に関するドキュメント</a>を読むと、<code>gcloud CLI</code> を使って長ったらしいコマンドを実行する必要がありそうなのがわかる。</p><p>これでは面倒だ。
いちいちオプションを打ちたくはないし、typo ばかり増えてミスに泣かされるだろう。
（<code>gcloud CLI</code> で実行した命令は <code>Ctrl+C</code> を受け付けない）</p><p>そこで、タスクランナーの出番だ。
python で書いているから、この場合は <code>pyptoject.toml</code> に書くのがいいだろう。
<code>poetry run task deploy-function</code> あたりにしておけば確実だ。
細かなオプションについては、後々考えることとする(<a href="https://cloud.google.com/functions/docs/configuring/env-var" target="_blank" rel="noopener noreferrer">環境変数はどうするの</a>とか)。</p><p><em>Scheduler</em> と <em>Pub/Sub</em> については、<a href="https://cloud.google.com/scheduler/docs/tut-pub-sub" target="_blank" rel="noopener noreferrer">Pub/Sub を使用して Cloud ファンクションをトリガーする | Cloud Scheduler のドキュメント | Google Cloud</a>を見ながらポチポチすればよい。</p><hr><p>これで、Cloud Scheduler (Cron) &lt;---&gt; Pub/Sub (Event Trigger) &lt;---&gt; Cloud Functions (Extraction and Translation) &lt;---&gt; GCS という形で定期的な自動実行が実現できそうな見通しが立てられたことになる。</p><p>先述の　 Load 自動化部分と組み合わせれば、ETL のワークフローすべてが自動化できたことになる。
BigQuery を使いこなして、座りしままに餅を食いたいねぇ……</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="Direct link to まとめ" title="Direct link to まとめ">​</a></h2><p>書籍から得た語彙の確認からはじめて、BigQuery 　と Cloud Storage の連携方法、Cloud Storage に自動で定期的にデータを集積する方法について、一から検討を重ねつつドキュメントを読み込んで全体設計を検討した。
サンプルコードには一切触れなかったが、参照先ドキュメントには豊富な事例がたくさんあるのでそれに倣うといいだろう。</p><p>次は、手元のデータ構造を見直しつつ、Cloud Functions の関数作成を行なって実装を完成に近づけよう。</p><div class="footnotes"><hr><ol><li id="fn-1-9d14e2"><a href="https://blog.g-gen.co.jp/entry/functions-2nd-gen-gcs-trigger" target="_blank" rel="noopener noreferrer">Cloud Storage トリガで Cloud Functions(2nd gen)を動かしてみた - G-gen Tech Blog</a><a href="#fnref-1-9d14e2" class="footnote-backref">↩</a></li><li id="fn-2-9d14e2">どちらも <code>datetime</code> 型としてフォーマットされた文字列である<a href="#fnref-2-9d14e2" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_Wr5y"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/python">python</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/競馬">競馬</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/gcs">GCS</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/dwh">DWH</a></li></ul></div><div class="col col--12"><div class="row"><div class="col col--8 margin-vert--sm"><div class="SocialButtons_nedk"><button aria-label="facebook" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#3b5998"></circle><path d="M34.1,47V33.3h4.6l0.7-5.3h-5.3v-3.4c0-1.5,0.4-2.6,2.6-2.6l2.8,0v-4.8c-0.5-0.1-2.2-0.2-4.1-0.2 c-4.1,0-6.9,2.5-6.9,7V28H24v5.3h4.6V47H34.1z" fill="white"></path></svg></button><button aria-label="twitter" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00aced"></circle><path d="M48,22.1c-1.2,0.5-2.4,0.9-3.8,1c1.4-0.8,2.4-2.1,2.9-3.6c-1.3,0.8-2.7,1.3-4.2,1.6 C41.7,19.8,40,19,38.2,19c-3.6,0-6.6,2.9-6.6,6.6c0,0.5,0.1,1,0.2,1.5c-5.5-0.3-10.3-2.9-13.5-6.9c-0.6,1-0.9,2.1-0.9,3.3 c0,2.3,1.2,4.3,2.9,5.5c-1.1,0-2.1-0.3-3-0.8c0,0,0,0.1,0,0.1c0,3.2,2.3,5.8,5.3,6.4c-0.6,0.1-1.1,0.2-1.7,0.2c-0.4,0-0.8,0-1.2-0.1 c0.8,2.6,3.3,4.5,6.1,4.6c-2.2,1.8-5.1,2.8-8.2,2.8c-0.5,0-1.1,0-1.6-0.1c2.9,1.9,6.4,2.9,10.1,2.9c12.1,0,18.7-10,18.7-18.7 c0-0.3,0-0.6,0-0.8C46,24.5,47.1,23.4,48,22.1z" fill="white"></path></svg></button><button aria-label="line" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#00b800"></circle><path d="M52.62 30.138c0 3.693-1.432 7.019-4.42 10.296h.001c-4.326 4.979-14 11.044-16.201 11.972-2.2.927-1.876-.591-1.786-1.112l.294-1.765c.069-.527.142-1.343-.066-1.865-.232-.574-1.146-.872-1.817-1.016-9.909-1.31-17.245-8.238-17.245-16.51 0-9.226 9.251-16.733 20.62-16.733 11.37 0 20.62 7.507 20.62 16.733zM27.81 25.68h-1.446a.402.402 0 0 0-.402.401v8.985c0 .221.18.4.402.4h1.446a.401.401 0 0 0 .402-.4v-8.985a.402.402 0 0 0-.402-.401zm9.956 0H36.32a.402.402 0 0 0-.402.401v5.338L31.8 25.858a.39.39 0 0 0-.031-.04l-.002-.003-.024-.025-.008-.007a.313.313 0 0 0-.032-.026.255.255 0 0 1-.021-.014l-.012-.007-.021-.012-.013-.006-.023-.01-.013-.005-.024-.008-.014-.003-.023-.005-.017-.002-.021-.003-.021-.002h-1.46a.402.402 0 0 0-.402.401v8.985c0 .221.18.4.402.4h1.446a.401.401 0 0 0 .402-.4v-5.337l4.123 5.568c.028.04.063.072.101.099l.004.003a.236.236 0 0 0 .025.015l.012.006.019.01a.154.154 0 0 1 .019.008l.012.004.028.01.005.001a.442.442 0 0 0 .104.013h1.446a.4.4 0 0 0 .401-.4v-8.985a.402.402 0 0 0-.401-.401zm-13.442 7.537h-3.93v-7.136a.401.401 0 0 0-.401-.401h-1.447a.4.4 0 0 0-.401.401v8.984a.392.392 0 0 0 .123.29c.072.068.17.111.278.111h5.778a.4.4 0 0 0 .401-.401v-1.447a.401.401 0 0 0-.401-.401zm21.429-5.287c.222 0 .401-.18.401-.402v-1.446a.401.401 0 0 0-.401-.402h-5.778a.398.398 0 0 0-.279.113l-.005.004-.006.008a.397.397 0 0 0-.111.276v8.984c0 .108.043.206.112.278l.005.006a.401.401 0 0 0 .284.117h5.778a.4.4 0 0 0 .401-.401v-1.447a.401.401 0 0 0-.401-.401h-3.93v-1.519h3.93c.222 0 .401-.18.401-.402V29.85a.401.401 0 0 0-.401-.402h-3.93V27.93h3.93z" fill="white"></path></svg></button><button aria-label="weibo" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#CD201F"></circle><path d="M40.9756152,15.0217119 C40.5000732,15.0546301 39.9999314,15.1204666 39.5325878,15.2192213 C38.6634928,15.4085016 38.0977589,16.2643757 38.2863368,17.1284787 C38.4667163,18.0008129 39.3194143,18.5686519 40.1885094,18.3793715 C42.8613908,17.8115326 45.7720411,18.6427174 47.7316073,20.8153207 C49.6911735,22.996153 50.2077122,25.975254 49.3714112,28.5840234 C49.1008441,29.4316684 49.5763861,30.3533789 50.4208857,30.6249537 C51.2653852,30.8965286 52.1754769,30.4192153 52.4542425,29.5715703 C53.6349013,25.9011885 52.9133876,21.7699494 50.1585171,18.7085538 C48.0923641,16.4042776 45.2063093,15.1533848 42.3530505,15.0217119 C41.8775084,14.9970227 41.4511594,14.9887937 40.9756152,15.0217119 Z M27.9227762,19.8277737 C24.9957268,20.140498 20.863421,22.4365431 17.2312548,26.0822378 C13.2711279,30.0571148 11,34.2871065 11,37.9328012 C11,44.9032373 19.8713401,49.125 28.5786978,49.125 C39.9917329,49.125 47.600423,42.4261409 47.600423,37.1427636 C47.600423,33.9496952 44.9603397,32.1638816 42.549827,31.4149913 C41.9594976,31.2339421 41.5167516,31.1434164 41.8283133,30.3616079 C42.5006339,28.66632 42.6236176,27.1932286 41.8939054,26.1480742 C40.5328692,24.1894405 36.7203236,24.2881952 32.448635,26.0822378 C32.448635,26.0822378 31.1203949,26.6912261 31.4647526,25.6213825 C32.1206742,23.4981576 32.0304845,21.712342 31.0056075,20.6836478 C30.2840938,19.9512176 29.2510184,19.6878718 27.9227762,19.8277737 Z M42.0906819,20.6836478 C41.6233383,20.6589586 41.1723917,20.716566 40.7132466,20.8153207 C39.9671353,20.9716828 39.4997917,21.7781784 39.6637721,22.5270687 C39.8277525,23.275959 40.5574647,23.7450433 41.303576,23.5804521 C42.1972686,23.3911718 43.2057485,23.6380596 43.8616701,24.3704897 C44.5175916,25.1029198 44.6733735,26.0657797 44.3864073,26.9381118 C44.1486363,27.6705419 44.5093932,28.4770397 45.2391054,28.7156963 C45.9688176,28.9461239 46.780521,28.5922524 47.0100936,27.8598223 C47.584026,26.0740087 47.2396661,24.0248493 45.8950269,22.5270687 C44.886547,21.4078489 43.4845162,20.7494842 42.0906819,20.6836478 Z M29.496988,29.9665891 C35.3100922,30.1723275 39.9917329,33.0691319 40.3852858,37.0769272 C40.8362324,41.6607904 35.5970585,45.9319315 28.6442899,46.6232144 C21.6915214,47.3144973 15.6488446,44.154347 15.197898,39.5787128 C14.7469514,34.9948495 20.059916,30.7237084 27.004486,30.0324256 C27.8735831,29.950131 28.6688875,29.9336709 29.496988,29.9665891 Z M25.5614586,34.3776322 C23.183744,34.5916017 20.9372116,35.9577073 19.9205332,37.9328012 C18.5348994,40.6238672 19.9041362,43.6029661 23.0689567,44.582284 C26.340366,45.5945202 30.1857056,44.0638213 31.5303448,41.1587879 C32.8503864,38.3195909 31.1613894,35.3734082 27.9227762,34.5751416 C27.1438688,34.3776322 26.356763,34.3035667 25.5614586,34.3776322 Z M24.052839,38.7228388 C24.3316067,38.7310678 24.5857748,38.8215935 24.8399449,38.9203482 C25.8648218,39.3400561 26.1845841,40.4428158 25.5614586,41.4221338 C24.9219361,42.3932227 23.5690963,42.8623069 22.5442194,42.4096807 C21.5357395,41.9652856 21.2487754,40.8542948 21.8882979,39.9078951 C22.3638421,39.2001542 23.2247386,38.7146097 24.052839,38.7228388 Z" fill="white"></path></svg></button><button aria-label="pocket" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#EF3F56"></circle><path d="M41.084 29.065l-7.528 7.882a2.104 2.104 0 0 1-1.521.666 2.106 2.106 0 0 1-1.522-.666l-7.528-7.882c-.876-.914-.902-2.43-.065-3.384.84-.955 2.228-.987 3.1-.072l6.015 6.286 6.022-6.286c.88-.918 2.263-.883 3.102.071.841.938.82 2.465-.06 3.383l-.015.002zm6.777-10.976C47.463 16.84 46.361 16 45.14 16H18.905c-1.2 0-2.289.82-2.716 2.044-.125.363-.189.743-.189 1.125v10.539l.112 2.096c.464 4.766 2.73 8.933 6.243 11.838.06.053.125.102.19.153l.04.033c1.882 1.499 3.986 2.514 6.259 3.014a14.662 14.662 0 0 0 6.13.052c.118-.042.235-.065.353-.087.03 0 .065-.022.098-.042a15.395 15.395 0 0 0 6.011-2.945l.039-.045.18-.153c3.502-2.902 5.765-7.072 6.248-11.852L48 29.674v-10.52c0-.366-.041-.728-.161-1.08l.022.015z" fill="white"></path></svg></button><button aria-label="hatena" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#009ad9"></circle><path d="M 36.164062 33.554688 C 34.988281 32.234375 33.347656 31.5 31.253906 31.34375 C 33.125 30.835938 34.476562 30.09375 35.335938 29.09375 C 36.191406 28.09375 36.609375 26.78125 36.609375 25.101562 C 36.628906 23.875 36.332031 22.660156 35.75 21.578125 C 35.160156 20.558594 34.292969 19.71875 33.253906 19.160156 C 32.304688 18.640625 31.175781 18.265625 29.847656 18.042969 C 28.523438 17.824219 26.195312 17.730469 22.867188 17.730469 L 14.769531 17.730469 L 14.769531 47.269531 L 23.113281 47.269531 C 26.46875 47.269531 28.886719 47.15625 30.367188 46.929688 C 31.851562 46.695312 33.085938 46.304688 34.085938 45.773438 C 35.289062 45.148438 36.28125 44.179688 36.933594 42.992188 C 37.597656 41.796875 37.933594 40.402344 37.933594 38.816406 C 37.933594 36.621094 37.347656 34.867188 36.164062 33.554688 Z M 22.257812 24.269531 L 23.984375 24.269531 C 25.988281 24.269531 27.332031 24.496094 28.015625 24.945312 C 28.703125 25.402344 29.042969 26.183594 29.042969 27.285156 C 29.042969 28.390625 28.664062 29.105469 27.9375 29.550781 C 27.210938 29.992188 25.84375 30.199219 23.855469 30.199219 L 22.257812 30.199219 Z M 29.121094 41.210938 C 28.328125 41.691406 26.976562 41.925781 25.078125 41.925781 L 22.257812 41.925781 L 22.257812 35.488281 L 25.195312 35.488281 C 27.144531 35.488281 28.496094 35.738281 29.210938 36.230469 C 29.925781 36.726562 30.304688 37.582031 30.304688 38.832031 C 30.304688 40.078125 29.914062 40.742188 29.105469 41.222656 Z M 29.121094 41.210938 M 46.488281 39.792969 C 44.421875 39.792969 42.742188 41.46875 42.742188 43.535156 C 42.742188 45.605469 44.421875 47.28125 46.488281 47.28125 C 48.554688 47.28125 50.230469 45.605469 50.230469 43.535156 C 50.230469 41.46875 48.554688 39.792969 46.488281 39.792969 Z M 46.488281 39.792969 M 43.238281 17.730469 L 49.738281 17.730469 L 49.738281 37.429688 L 43.238281 37.429688 Z M 43.238281 17.730469 " fill="white"></path></svg></button><button aria-label="reddit" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#ff4500"></circle><path d="m 52.8165,31.942362 c 0,-2.4803 -2.0264,-4.4965 -4.5169,-4.4965 -1.2155,0 -2.3171,0.4862 -3.128,1.2682 -3.077,-2.0247 -7.2403,-3.3133 -11.8507,-3.4782 l 2.5211,-7.9373 6.8272,1.5997 -0.0102,0.0986 c 0,2.0281 1.6575,3.6771 3.6958,3.6771 2.0366,0 3.6924,-1.649 3.6924,-3.6771 0,-2.0281 -1.6575,-3.6788 -3.6924,-3.6788 -1.564,0 -2.8968,0.9758 -3.4357,2.3443 l -7.3593,-1.7255 c -0.3213,-0.0782 -0.6477,0.1071 -0.748,0.4233 L 32,25.212062 c -4.8246,0.0578 -9.1953,1.3566 -12.41,3.4425 -0.8058,-0.7446 -1.8751,-1.2104 -3.0583,-1.2104 -2.4905,0 -4.5152,2.0179 -4.5152,4.4982 0,1.649 0.9061,3.0787 2.2389,3.8607 -0.0884,0.4794 -0.1462,0.9639 -0.1462,1.4569 0,6.6487 8.1736,12.0581 18.2223,12.0581 10.0487,0 18.224,-5.4094 18.224,-12.0581 0,-0.4658 -0.0493,-0.9248 -0.1275,-1.377 1.4144,-0.7599 2.3885,-2.2304 2.3885,-3.9406 z m -29.2808,3.0872 c 0,-1.4756 1.207,-2.6775 2.6894,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 -1.4824,0 -2.6894,-1.2002 -2.6894,-2.6758 z m 15.4037,7.9373 c -1.3549,1.3481 -3.4816,2.0043 -6.5008,2.0043 l -0.0221,-0.0051 -0.0221,0.0051 c -3.0209,0 -5.1476,-0.6562 -6.5008,-2.0043 -0.2465,-0.2448 -0.2465,-0.6443 0,-0.8891 0.2465,-0.2465 0.6477,-0.2465 0.8942,0 1.105,1.0999 2.9393,1.6337 5.6066,1.6337 l 0.0221,0.0051 0.0221,-0.0051 c 2.6673,0 4.5016,-0.5355 5.6066,-1.6354 0.2465,-0.2465 0.6477,-0.2448 0.8942,0 0.2465,0.2465 0.2465,0.6443 0,0.8908 z m -0.3213,-5.2615 c -1.4824,0 -2.6877,-1.2002 -2.6877,-2.6758 0,-1.4756 1.2053,-2.6775 2.6877,-2.6775 1.4824,0 2.6877,1.2019 2.6877,2.6775 0,1.4756 -1.2053,2.6758 -2.6877,2.6758 z" fill="white"></path></svg></button><button aria-label="telegram" style="background-color:transparent;border:none;padding:0;font:inherit;color:inherit;cursor:pointer;outline:none"><svg viewBox="0 0 64 64" width="32" height="32"><circle cx="32" cy="32" r="31" fill="#37aee2"></circle><path d="m45.90873,15.44335c-0.6901,-0.0281 -1.37668,0.14048 -1.96142,0.41265c-0.84989,0.32661 -8.63939,3.33986 -16.5237,6.39174c-3.9685,1.53296 -7.93349,3.06593 -10.98537,4.24067c-3.05012,1.1765 -5.34694,2.05098 -5.4681,2.09312c-0.80775,0.28096 -1.89996,0.63566 -2.82712,1.72788c-0.23354,0.27218 -0.46884,0.62161 -0.58825,1.10275c-0.11941,0.48114 -0.06673,1.09222 0.16682,1.5716c0.46533,0.96052 1.25376,1.35737 2.18443,1.71383c3.09051,0.99037 6.28638,1.93508 8.93263,2.8236c0.97632,3.44171 1.91401,6.89571 2.84116,10.34268c0.30554,0.69185 0.97105,0.94823 1.65764,0.95525l-0.00351,0.03512c0,0 0.53908,0.05268 1.06412,-0.07375c0.52679,-0.12292 1.18879,-0.42846 1.79109,-0.99212c0.662,-0.62161 2.45836,-2.38812 3.47683,-3.38552l7.6736,5.66477l0.06146,0.03512c0,0 0.84989,0.59703 2.09312,0.68132c0.62161,0.04214 1.4399,-0.07726 2.14229,-0.59176c0.70766,-0.51626 1.1765,-1.34683 1.396,-2.29506c0.65673,-2.86224 5.00979,-23.57745 5.75257,-27.00686l-0.02107,0.08077c0.51977,-1.93157 0.32837,-3.70159 -0.87096,-4.74991c-0.60054,-0.52152 -1.2924,-0.7498 -1.98425,-0.77965l0,0.00176zm-0.2072,3.29069c0.04741,0.0439 0.0439,0.0439 0.00351,0.04741c-0.01229,-0.00351 0.14048,0.2072 -0.15804,1.32576l-0.01229,0.04214l-0.00878,0.03863c-0.75858,3.50668 -5.15554,24.40802 -5.74203,26.96472c-0.08077,0.34417 -0.11414,0.31959 -0.09482,0.29852c-0.1756,-0.02634 -0.50045,-0.16506 -0.52679,-0.1756l-13.13468,-9.70175c4.4988,-4.33199 9.09945,-8.25307 13.744,-12.43229c0.8218,-0.41265 0.68483,-1.68573 -0.29852,-1.70681c-1.04305,0.24584 -1.92279,0.99564 -2.8798,1.47502c-5.49971,3.2626 -11.11882,6.13186 -16.55882,9.49279c-2.792,-0.97105 -5.57873,-1.77704 -8.15298,-2.57601c2.2336,-0.89555 4.00889,-1.55579 5.75608,-2.23009c3.05188,-1.1765 7.01687,-2.7042 10.98537,-4.24067c7.94051,-3.06944 15.92667,-6.16346 16.62028,-6.43037l0.05619,-0.02283l0.05268,-0.02283c0.19316,-0.0878 0.30378,-0.09658 0.35471,-0.10009c0,0 -0.01756,-0.05795 -0.00351,-0.04566l-0.00176,0zm-20.91715,22.0638l2.16687,1.60145c-0.93418,0.91311 -1.81743,1.77353 -2.45485,2.38812l0.28798,-3.98957" fill="white"></path></svg></button></div></div><div class="col col--4 margin-vert--sm"><a href="https://github.com/ningensei848/ningensei848.github.io/edit/main/content/blogs/2023/02/07.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg><wbr>編集をリクエスト</a></div></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2023/02/01"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">2023 年を考える</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2023/03/03"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">netkeiba のデータをスクレイピングして LOD 化する（7）</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#データレイクとデータウェアハウスdwh" class="table-of-contents__link toc-highlight">データレイクとデータウェアハウス（DWH）</a></li><li><a href="#google-cloud-storage-と-bigquery" class="table-of-contents__link toc-highlight">Google: Cloud Storage と BigQuery</a><ul><li><a href="#データの読み込み" class="table-of-contents__link toc-highlight">データの読み込み</a></li><li><a href="#読み込みに関する注意点" class="table-of-contents__link toc-highlight">読み込みに関する注意点</a></li></ul></li><li><a href="#さらなる自動化を目指して" class="table-of-contents__link toc-highlight">さらなる自動化を目指して</a><ul><li><a href="#github-actions" class="table-of-contents__link toc-highlight">GitHub Actions</a></li><li><a href="#gce" class="table-of-contents__link toc-highlight">GCE</a></li><li><a href="#cloud-scheduler-x-pubsub-trigger-x-cloud-functions" class="table-of-contents__link toc-highlight">Cloud Scheduler x Pub/Sub trigger x Cloud Functions</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/logo.svg" alt="Kiai de Nantoka" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/logo_dark.svg" alt="Kiai de Nantoka" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 ningensei848, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e370ff11.js"></script>
<script src="/assets/js/main.903cefa2.js"></script>
</body>
</html>