---
# @see https://docusaurus.io/docs/api/plugins/@docusaurus/plugin-content-blog#markdown-front-matter
# Metadata (Recommended) ------------------------------------
title: "netkeiba ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ LOD åŒ–ã™ã‚‹ï¼ˆï¼•ï¼‰"
date: "2022-03-30"
tags:
  - "python"
  - "ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°"
  - "ç«¶é¦¬"
# draft: true  # if true, the article is `WIP` and therefore should not be published yet
# Allows to customize the blog post url (/<routeBasePath>/<slug>)
# slug: ''   # default is current file path
authors: kiai  # @see authors.yml
# -----------------------------------------------------------
# Additional ------------------------------------------------
# hide_table_of_contents:   # if true, rightside ToC will be invisible
# toc_min_heading_level: 2  # The minimum heading level shown in the ToC
# toc_max_heading_level: 3  # The max heading level shown in the ToC
# for SEO
keywords:
  - "python"
  - "ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°"
  - "ç«¶é¦¬"
# description: '<Desc>'
# for `og:image` and `twitter:image` (.png or .jpg, NOT .svg)
image: https://custom-og-image-generator.vercel.app/api/**netkeiba.com**%20%E3%81%AE%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E3%82%B9%E3%82%AF%E3%83%AC%E3%82%A4%E3%83%94%E3%83%B3%E3%82%B0%E3%81%97%E3%81%A6LOD%E5%8C%96%E3%81%99%E3%82%8B.png?theme=light&copyright=Kiai+de+Nantoka&logo=https%3A%2F%2Fimg.icons8.com%2Fglyph-neue%2F64%2F000000%2Fhorse.png&avater=https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F20794309&author=Kiai&aka=%40Ningensei848&site=%E6%B0%97%E5%90%88%E3%81%A7%E3%81%AA%E3%82%93%E3%81%A8%E3%81%8B&tags=%E7%AB%B6%E9%A6%AC&tags=scraping&tags=Python&tags=LOD
---

ã¾ã  zenn.dev ã«è¨˜äº‹ã¨ã—ã¦ã¾ã¨ã‚ã‚‹ã“ã¨ã¯å‡ºæ¥ã¦ã„ãªã„ãŒï¼Œç€ã€…ã¨è‡ªå‹•åŒ–å‡¦ç†ãŒä½œæˆã§ãã¦ããŸï¼

ä¸€æ–¹ã§ï¼Œã‚¨ãƒ©ãƒ¼ã«é–¢ã—ã¦ã‚‚ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãŒç¾ã‚ŒãŸã®ã§ãã®ä¾‹å¤–å‡¦ç†ã‚‚ãƒ—ãƒãƒ—ãƒã‚„ã£ã¦ã„ãï¼

<!-- truncate -->

## è‡ªå‹•åŒ–å‡¦ç†

`dailyUpdate.py` ã‚’ãƒ¡ã‚¤ãƒ³ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã®ã§ã¯ãªãï¼Œåå¾©å‡¦ç†ã®ä¸€éƒ¨ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ï¼
ã™ãªã‚ã¡ï¼Œ~~å…ƒæ—¥ã‹ã‚‰å¤§æ™¦æ—¥ã¾ã§ä¸€æ—¥ãšã¤~~ å¤§æ™¦æ—¥ã‹ã‚‰å…ƒæ—¥ã¾ã§ä¸€æ—¥ãšã¤[^1] `dailyUpdate.py` ã«æ¸¡ã—ã¦ 365 æ—¥å‡¦ç†ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼

[^1]: é¡ã£ã¦ã„ãã»ã†ãŒï¼Œæ—¢çŸ¥ã® ID ã¨è¡çªã—ã‚„ã™ã„ï¼ˆé‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¸›ã‚‰ã—ã‚„ã™ã„ï¼‰ã¨è€ƒãˆç›´ã—ãŸï¼ˆãŒï¼Œãã“ã¾ã§ã®é•ã„ã¯ãªã„ã‹ã‚‚ï¼Ÿï¼‰

```python
firstDay = date(2021, 12, 31)

today = firstDay

loop_size = 365

for loop in range(loop_size):
    print("now is ", today)
    targetDate = sum([today.year * 10 ** 4, today.month * 10 ** 2, today.day])
    updateDaily(targetDate)  # int(YYYYMMDD) ã‚’æ¸¡ã™
    today -= timedelta(days=1)
```

### ã“ã¾ã‚ã«ã‚³ãƒŸãƒƒãƒˆ

ã¾ãŸï¼Œä¸€å¹´åˆ†ã‚‚å‡¦ç†ã‚’ã™ã‚‹ã¨å¾—ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ•°ãŒè†¨å¤§ãªã‚‚ã®ã¨ãªã‚Šï¼Œã‚ã¨ã§ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã®ã«æ”¯éšœã‚’ããŸã™ã‹ã‚‚ã—ã‚Œãªã„ï¼
ãã®ãŸã‚ï¼Œä¸€é€±é–“ã”ã¨ã«ã“ã¾ã‚ã«ã‚³ãƒŸãƒƒãƒˆã•ã›ã‚‹ï¼

```python
def makeCommands():
    dt = datetime.now(timezone(timedelta(hours=9))).strftime("%Y-%m-%d %H:%M:%S")
    git_add = ["git", "add", "."]
    git_commit = ["git", "commit", "-m", f"Update: horse and race data || {dt}"]
    git_gc = ["git", "gc", "--prune=all"]
    git_push = ["git", "push"]

    return [git_add, git_commit, git_gc, git_push]


def gitCommit():
    for proc in makeCommands():
        subprocess.run(proc, encoding="utf-8", stdout=subprocess.PIPE)
```

```python
firstDay = date(2021, 12, 31)

today = firstDay

loop_size = 365

for loop in range(loop_size):
    print("now is ", today)
    targetDate = sum([today.year * 10 ** 4, today.month * 10 ** 2, today.day])
    updateDaily(targetDate)  # int(YYYYMMDD) ã‚’æ¸¡ã™
    today -= timedelta(days=1)
    # highlight-start
    # ã“ã¾ã‚ã«ã‚³ãƒŸãƒƒãƒˆ
    if loop % 7 == 6:
        gitCommit()
    # highlight-start
```

### ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨åˆ¤å®šï¼ˆé‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãªãã™ï¼‰

ã•ã‚‰ã«ï¼Œå‡¦ç†ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã«æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰ç„¡ã«ã‚ˆã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¸›ã‚‰ã™ï¼
`horse_id` ã«ã‚ˆã£ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŠã‚ˆã³ HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹ãŒï¼Œ[`pathlib`](https://docs.python.org/ja/3/library/pathlib.html) ã«ã‚ˆã£ã¦ã“ã® ID ã‚’æŒã¤ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ï¼Œ`Path.exists()` ã§å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹ï¼
ãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆã«çµã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œãˆã°ï¼Œå‡¦ç†ãŒç¹°ã‚Šè¿”ã•ã‚Œã‚‹ãŸã³ã« 1 ãƒ«ãƒ¼ãƒ—ã«å¿…è¦ãªæ™‚é–“ã¯æ¸›ã£ã¦ã„ãã“ã¨ã ã‚ã†ï¼

```python title="filter.py"
from pathlib import Path

cwd = Path.cwd()


def getHorsePath(horse_id: str, dir="json") -> Path:

    yyyy, xxxx, zz = horse_id[:4], horse_id[4:8], horse_id[8:]
    filepath = cwd / "data" / "horse" / dir / "profile" / yyyy / xxxx / f"{zz}.json"

    return filepath

def filteringDuplicated(horse_list: List[str]) -> List[str]:

    unregistered_horse_id = [horse_id for horse_id in horse_list if not getHorsePath(horse_id).exists()]
    return unregistered_horse_id
```

## `UnicodeDecodeError`

```python title="UnicodeDecodeError: 'euc_jp' codec can't decode byte 0xf9"
Traceback (most recent call last):
  File "python/temp.py", line 36, in <module>
    updateDaily(targetDate)
  File "/path/to/ML4Keiba/python/dailyUpdate.py", line 65, in main
    processHorseData(horse_list=horse_list, limit=PARALLEL_LIMIT)
  File "/path/to/ML4Keiba/python/getHorseProfile.py", line 503, in main
    loop.run_until_complete(_run(horse_list, coro, limit))
  File "/usr/lib/python3.8/asyncio/base_events.py", line 616, in run_until_complete
    return future.result()
  File "/path/to/ML4Keiba/python/getHorseProfile.py", line 491, in _run
    responses = await tqdm.gather(*tasks)  # wrapper for asyncio.gather
  File "/path/to/ML4Keiba/.venv/lib/python3.8/site-packages/tqdm/asyncio.py", line 79, in gather
    res = [await f for f in cls.as_completed(ifs, loop=loop, timeout=timeout,
  File "/path/to/ML4Keiba/.venv/lib/python3.8/site-packages/tqdm/asyncio.py", line 79, in <listcomp>
    res = [await f for f in cls.as_completed(ifs, loop=loop, timeout=timeout,
  File "/usr/lib/python3.8/asyncio/tasks.py", line 619, in _wait_for_one
    return f.result()  # May raise f.exception().
  File "/path/to/ML4Keiba/.venv/lib/python3.8/site-packages/tqdm/asyncio.py", line 76, in wrap_awaitable
    return i, await f
  File "/path/to/ML4Keiba/python/getHorseProfile.py", line 468, in _bound_fetch
    return await _fetch(session, horse_id, coro)
  File "/path/to/ML4Keiba/python/getHorseProfile.py", line 455, in _fetch
    return await coro(horse_id, res_top, res_ped)
  File "/path/to/ML4Keiba/python/getHorseProfile.py", line 407, in coroutine
    content_top = await res_top.text(encoding=ENCODING)
  File "/path/to/ML4Keiba/.venv/lib/python3.8/site-packages/aiohttp/client_reqrep.py", line 1085, in text
    return self._body.decode(  # type: ignore[no-any-return,union-attr]
UnicodeDecodeError: 'euc_jp' codec can't decode byte 0xf9 in position 26711: illegal multibyte sequence
```

ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ `euc-jp` ã§èª­ã¿è¾¼ã‚€ã¨ãã«ï¼Œã€Œ**é«™ï¨‘**ã€ãŒæ‚ªã•ã‚’ã—ã¦ `UnicodeDecodeError` ãŒèµ·ãã¦ã—ã¾ã£ãŸï¼

https://qiita.com/inoory/items/aafe79384dbfcc0802cf#ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã‚’æŒ‡å®šã—ãŸã¨ãã®ãƒ‡ã‚³ãƒ¼ãƒ‰çµæœ

ã„ã‚ã„ã‚è©¦ã—ãŸã¨ã“ã‚ï¼Œ`surrogateescape` ã ã¨ã†ã¾ãã„ãã¨ãã¨ãã†ã§ãªã„å ´åˆãŒã‚ã‚‹ã‚ˆã†ã ï¼
ä¸€æ–¹ã§ `backslashreplace` ã ã¨å¸¸ã«æˆåŠŸã™ã‚‹ãŒï¼Œ`\\xe3\\x81\\xb2\\xe3\\x82\\x89\\xe3\\x82` ã®ã‚ˆã†ãªè¡¨è¨˜ãŒãƒ‡ãƒ¼ã‚¿ä¸Šã«æ®‹ã£ã¦ã—ã¾ã†ï¼

ç¾çŠ¶ï¼Œã†ã¾ãå›é¿ã™ã‚‹æ–¹æ³•ãŒï¼ˆè‡ªåˆ†ã§ã¯ï¼‰ã‚ˆãã‚ã‹ã£ã¦ã„ãªã„ãŸã‚ï¼Œ`try-except` æ§‹æ–‡ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã‚‹ãŸã³ãã‚Œã‚’å›é¿ã™ã‚‹æ–¹æ³•ã‚’å–ã‚‹ã“ã¨ã¨ã™ã‚‹ï¼

```python
content_top = await res_top.text(encoding=ENCODING, errors="surrogateescape")
content_ped = await res_ped.text(encoding=ENCODING, errors="surrogateescape")

try:
    meta = getHorseMeta(BeautifulSoup(content_top, "lxml"))
except Exception as e:
    print(e, file=sys.stderr)
    content_top = await res_top.text(encoding=ENCODING, errors="backslashreplace")
    meta = getHorseMeta(BeautifulSoup(content_top, "lxml"))

ped = getHorsePed(BeautifulSoup(content_ped, "lxml"))
```

[codecs --- codec ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¨åŸºåº•ã‚¯ãƒ©ã‚¹ â€” Python 3.10.0b2 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.python.org/ja/3/library/codecs.html#error-handlers) ã¨ã‹ [Python ã§ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ -- ã»ã£ã‘ã®é€†è¥² - ä»Šå·é¤¨](https://imagawa.hatenadiary.jp/entry/2016/12/25/193000) ã‚ãŸã‚ŠãŒæ­£è§£ãªã‚“ã˜ã‚ƒã‚ãªã„ã‹ãªï½ï½ã¨æ€ã„ã¤ã¤ï¼Œã¨ã‚Šã‚ãˆãšç¾æ®µéšã§ã¯ãƒ‡ãƒ¼ã‚¿åé›†ã‚’å„ªå…ˆã™ã‚‹ï¼

ã‚ã¨ã«ãªã£ã¦ä½™è£•ãŒã§ãã¦ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ã‚’è¡Œãˆã°ã‚ˆã„ã ã‚ã†ï¼ˆãƒ¨ã‚·ãƒƒï¼ğŸ‘ˆğŸ˜¹ï¼‰

## `getId()`

`getId()` ã§ä¸ãˆã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã‹ã‚‰ ID ã‚’å¼•ã£ã“æŠœã„ã¦ã„ãŸãŒï¼Œä»¥å¤–ã«ã‚‚ãƒ­ãƒã‚¹ãƒˆãƒã‚¹ãŒä½ã„ã“ã¨ãŒã‚ã‹ã£ãŸãŸã‚ï¼Œå‡¦ç†ã‚’å†—é•·åŒ–ã—ãŸï¼

æ­£è¦è¡¨ç¾ã‚’ä½¿ã†ã®ã‚‚ã‚¢ãƒªã§ã¯ã‚ã‚‹ã®ã ãŒï¼Œãƒ—ãƒ­ãƒã‚¤ãƒ€å´ã§ ID ã®è¡¨è¨˜ãƒ«ãƒ¼ãƒ«ã‚’å¤‰æ›´ã•ã‚ŒãŸã‚‰è¿½å¾“ã—ã«ãã„ãŸã‚ï¼Œåˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã£ãŸï¼

```python
def getId(url: str) -> str:

    if type(url) is int:
        return str(url)

    if type(url) is not str:
        return None

    res = url.strip("/").split("/")[-1]
    if len(res) < 1:
        return None

    id_ = res.split("=")[-1]

    return id_
```

ã¨ã‚Šã‚ãˆãšæœ¬æ—¥ã¾ã§ã®é€²æ—ã¯ã“ã‚“ãªã¨ã“ã‚ã ã‚ã†ã‹ï¼

ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ã®èª²é¡Œã«ã¤ã„ã¦ã¯é©å®œ Issue ã‚’å»ºã¦ã¦å¾Œã‹ã‚‰å‚ç…§ã—ã¦ç›´ã™ã“ã¨ã«ãªã‚‹ã ã‚ã†ï¼
æœªæ¥ã®è‡ªåˆ†ã«ã¶ã‚“æŠ•ã’ã¦ç”³ã—è¨³ãªã„â€¦â€¦ğŸ˜¢
